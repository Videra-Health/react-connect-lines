var e=require("react"),t=require("react/jsx-runtime");function o(e,t,o,n){Object.defineProperty(e,t,{get:o,set:n,enumerable:!0,configurable:!0})}o(module.exports,"Connect",(()=>l)),o(module.exports,"ConnectProvider",(()=>g)),o(module.exports,"ConnectLines",(()=>p));const n=(0,e.createContext)({elements:[],dispatch:()=>null});function r(){if(!(0,e.useContext)(n))throw new Error("Missing context value");return(0,e.useContext)(n)}function i(e,t){const{type:o,id:n,element:r,connectWith:i}=t,s=e?.elements?.some((e=>e.id===n)),l={id:n,element:r,connectWith:i||[]};if("add"===o&&r){if(!s)return{...e,elements:[...e.elements,l]};if(s){const t=[...e.elements].map((e=>e.id===n?l:e));return{...e,elements:t}}return e}return"remove"===o?{...e,elements:e.elements.map((e=>({...e,connectWith:e.connectWith?.filter((e=>e.id!==n))}))).filter((e=>e.id!==n))}:e}function s(o){const{children:r}=o,[s,l]=(0,e.useReducer)(i,{elements:[],dispatch:()=>null}),c=(0,e.useMemo)((()=>({elements:s.elements,dispatch:l})),[s]);return(0,t.jsx)(n.Provider,{value:c,children:r})}function l(t){const{children:o,id:n,connectWith:i}=t,{dispatch:s}=r(),l=(0,e.useRef)(),c=(0,e.useCallback)((()=>{s({type:"add",id:n,connectWith:i,element:l.current})}),[i,s,n]),d=(0,e.useMemo)((()=>{const{props:t}=o;return(0,e.cloneElement)(o,{...t,ref:e=>{l.current=e,"function"==typeof o&&t.ref(e)}})}),[o]);return(0,e.useEffect)((()=>{c()}),[t,c,l]),(0,e.useEffect)((()=>()=>{s({type:"remove",id:n})}),[s,n]),d}const c=e=>{const{paths:t,edge:o}=e;return`M ${t.map(((e,t)=>1===t&&"step"===o?`${e.x} ${e.y}`:1===t&&"bezier"===o?`C ${e.x} ${e.y}`:`${e.x} ${e.y}`)).join(" ")}`};function d(e){return e.element?e.element:document.querySelector(`#${e.id}`)}const f=[];function u(e){const{elements:t}=e;return t.filter((e=>(e?.connectWith||f).length>0)).map((e=>{const{connectWith:o}=e,n=t.filter((e=>o?.map((e=>e.id)).includes(e.id))).map((e=>({rect:d(e)?.getBoundingClientRect(),color:o?.find((t=>t.id===e.id))?.color||"#000000",edge:o?.find((t=>t.id===e.id))?.edge||"bezier",stroke:o?.find((t=>t.id===e.id))?.stroke||"solid",id:e.id})));if(0!==n.length)return{from:{...e,rect:d(e)?.getBoundingClientRect()},to:n}})).filter(Boolean)}function m(e){const{from:t,to:o,root:n}=e,r=t?.rect,i=o?.rect,s=n?.rect;if(!r||!i||!s)return;const l=function(e){const{from:t,to:o}=e,n=t.left-40<o.right&&t.right+o.width>o.right-40,r=t.bottom<o.top&&n,i=t.top>o.bottom&&n,s=t.left>o.right,l=t.right<o.left;return r?"bottom-to-top":i?"top-to-bottom":s?"right-to-left":l?"left-to-right":void 0}({from:r,to:i});switch(l){case"bottom-to-top":return[{x:r?.left+r.width/2-s?.left,y:r?.bottom-s?.top},{x:r?.left+r.width/2-s?.left,y:r.bottom-(r.bottom-i.top)/2-s?.top},{x:i?.left+i.width/2-s?.left,y:r.bottom-(r.bottom-i.top)/2-s?.top},{x:i?.left+i.width/2-s?.left,y:i.top-9-s?.top}];case"top-to-bottom":return[{x:r?.left+r.width/2-s?.left,y:r?.top-s?.top},{x:r?.left+r.width/2-s?.left,y:r.top-(r.top-i.bottom)/2-s?.top},{x:i?.left+i.width/2-s?.left,y:r.top-(r.top-i.bottom)/2-s?.top},{x:i?.left+i.width/2-s?.left,y:i.bottom+9-s?.top}];case"right-to-left":return[{x:r?.left-s?.left,y:r?.bottom-r.height/2-s?.top},{x:(i.right+r.left)/2-s?.left,y:r?.bottom-r.height/2-s?.top},{x:(i.right+r.left)/2-s?.left,y:i.top+i.height/2-s?.top},{x:i.right+9-s?.left,y:i.top+i.height/2-s?.top}];case"left-to-right":return[{x:r?.right-s?.left,y:r?.bottom-r.height/2-s?.top},{x:(i.left+r.right)/2-s?.left,y:r?.bottom-r.height/2-s?.top},{x:(i.left+r.right)/2-s?.left,y:i.top+i.height/2-s?.top},{x:i.left-9-s?.left,y:i.top+i.height/2-s?.top}];default:return[]}}const a={position:"fixed",top:"0",left:"0",right:"0",bottom:"0",pointerEvents:"none",width:"100%",height:"100%"},h=[];function p(o){const[n,r]=(0,e.useState)(h),[i,s]=(0,e.useState)(!1),{elements:l}=o,f=(0,e.useRef)(null),p=(0,e.useRef)(),v=(0,e.useMemo)((()=>[...new Set([...l.map((e=>e.connectWith?.map((e=>e?.color)))).flat(),"#000000"])].filter(Boolean)),[l]),g=(0,e.useCallback)((()=>{p.current&&window.cancelAnimationFrame(p.current),p.current=window.requestAnimationFrame((()=>{const e=u({elements:l}).map((e=>{const{from:t,to:o}=e||{},n=o?.map((e=>{const o=m({from:t,to:e,root:{rect:f.current.getBoundingClientRect()}});if(!o)return;const n=c({paths:o,edge:e?.edge});return/\d/.test(n)?{fromId:t?.id,toId:e?.id,d:n,...e}:void 0}));return n})).filter(Boolean).flat().filter((e=>Boolean(e)));r(e)}))}),[l]),x=(0,e.useCallback)((()=>{s(!0)}),[]),b=(0,e.useCallback)((()=>{s(!1)}),[]),w=(0,e.useCallback)((()=>{i&&g()}),[g,i]);(0,e.useEffect)((()=>{g()}),[g]),(0,e.useEffect)((()=>(window.addEventListener("resize",g,{passive:!0}),window.addEventListener("scroll",g,{passive:!0}),()=>{window.removeEventListener("resize",g),window.removeEventListener("scroll",g)})),[g]);const y=(0,e.useMemo)((()=>new ResizeObserver(g)),[g]);return(0,e.useEffect)((()=>(l.forEach((e=>{const t=d(e);t?.addEventListener("mousedown",x,{passive:!0}),t?.addEventListener("mouseup",b,{passive:!0}),t?.addEventListener("mousemove",w,{passive:!0}),t?.addEventListener("touchstart",x,{passive:!0}),t?.addEventListener("touchend",b,{passive:!0}),t?.addEventListener("touchmove",w,{passive:!0}),t&&y.observe(t)})),()=>{l.forEach((e=>{const t=d(e);t?.removeEventListener("mousedown",x),t?.removeEventListener("mouseup",b),t?.removeEventListener("mousemove",w),t?.removeEventListener("touchstart",x),t?.removeEventListener("touchend",b),t?.removeEventListener("touchmove",w),t&&(y.disconnect(),y.unobserve(t))}))})),[l,g,x,b,w,y]),(0,e.useMemo)((()=>(0,t.jsxs)("svg",{style:a,ref:f,children:[v?.map((e=>(0,t.jsx)("defs",{children:(0,t.jsx)("marker",{id:`triangle-${e}`,markerHeight:"5",markerUnits:"strokeWidth",markerWidth:"5",orient:"auto",refX:"1",refY:"5",viewBox:"0 0 10 10",children:(0,t.jsx)("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:e})})},e))),n?.map((e=>(0,t.jsx)("path",{id:`${e?.fromId}~${e?.toId}`,d:e?.d,fill:"none",markerEnd:`url(#triangle-${e?.color})`,stroke:e?.color,strokeWidth:"2",strokeDasharray:"dashed"===e?.stroke?4:0,strokeLinejoin:"round"},e?.d)))]})),[v,n])}function v(){const{elements:e}=r();return(0,t.jsx)(p,{elements:e})}function g(e){const{children:o}=e;return(0,t.jsxs)(s,{children:[o,(0,t.jsx)(v,{})]})}
//# sourceMappingURL=index.js.map
