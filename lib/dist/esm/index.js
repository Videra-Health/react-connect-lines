import{useRef as e,useCallback as t,useMemo as o,cloneElement as n,useEffect as r,createContext as i,useContext as s,useReducer as c,useState as d}from"react";import{jsx as l,jsxs as m}from"react/jsx-runtime";const a=i({elements:[],dispatch:()=>null});function h(){if(!s(a))throw new Error("Missing context value");return s(a)}function u(e,t){const{type:o,id:n,element:r,connectWith:i}=t,s=e?.elements?.some((e=>e.id===n)),c={id:n,element:r,connectWith:i||[]};if("add"===o&&r){if(!s)return{...e,elements:[...e.elements,c]};if(s){const t=[...e.elements].map((e=>e.id===n?c:e));return{...e,elements:t}}return e}return"remove"===o?{...e,elements:e.elements.map((e=>({...e,connectWith:e.connectWith?.filter((e=>e.id!==n))}))).filter((e=>e.id!==n))}:e}function f(e){const{children:t}=e,[n,r]=c(u,{elements:[],dispatch:()=>null}),i=o((()=>({elements:n.elements,dispatch:r})),[n]);return l(a.Provider,{value:i,children:t})}function p(i){const{children:s,id:c,connectWith:d}=i,{dispatch:l}=h(),m=e(),a=t((()=>{l({type:"add",id:c,connectWith:d,element:m.current})}),[d,l,c]),u=o((()=>{const{props:e}=s;return n(s,{...e,ref:t=>{m.current=t,"function"==typeof s&&e.ref(t)}})}),[s]);return r((()=>{a()}),[i,a,m]),r((()=>()=>{l({type:"remove",id:c})}),[l,c]),u}const v=e=>{const{paths:t,edge:o}=e;return`M ${t.map(((e,t)=>1===t&&"step"===o?`${e.x} ${e.y}`:1===t&&"bezier"===o?`C ${e.x} ${e.y}`:`${e.x} ${e.y}`)).join(" ")}`};function g(e){return e.element?e.element:document.querySelector(`#${e.id}`)}const w=[];function x(e){const{elements:t}=e;return t.filter((e=>(e?.connectWith||w).length>0)).map((e=>{const{connectWith:o}=e,n=t.filter((e=>o?.map((e=>e.id)).includes(e.id))).map((e=>({rect:g(e)?.getBoundingClientRect(),color:o?.find((t=>t.id===e.id))?.color||"#000000",edge:o?.find((t=>t.id===e.id))?.edge||"bezier",stroke:o?.find((t=>t.id===e.id))?.stroke||"solid",id:e.id})));if(0!==n.length)return{from:{...e,rect:g(e)?.getBoundingClientRect()},to:n}})).filter(Boolean)}function y(e){const{from:t,to:o}=e,n=t?.rect,r=o?.rect;if(!n||!r)return;const i=function(e){const{from:t,to:o}=e,n=t.left-40<o.right&&t.right+o.width>o.right-40,r=t.bottom<o.top&&n,i=t.top>o.bottom&&n,s=t.left>o.right,c=t.right<o.left;return r?"bottom-to-top":i?"top-to-bottom":s?"right-to-left":c?"left-to-right":void 0}({from:n,to:r});switch(i){case"bottom-to-top":return[{x:n?.left+n.width/2,y:n?.bottom},{x:n?.left+n.width/2,y:n.bottom-(n.bottom-r.top)/2},{x:r?.left+r.width/2,y:n.bottom-(n.bottom-r.top)/2},{x:r?.left+r.width/2,y:r.top-9}];case"top-to-bottom":return[{x:n?.left+n.width/2,y:n?.top},{x:n?.left+n.width/2,y:n.top-(n.top-r.bottom)/2},{x:r?.left+r.width/2,y:n.top-(n.top-r.bottom)/2},{x:r?.left+r.width/2,y:r.bottom+9}];case"right-to-left":return[{x:n?.left,y:n?.bottom-n.height/2},{x:(r.right+n.left)/2,y:n?.bottom-n.height/2},{x:(r.right+n.left)/2,y:r.top+r.height/2},{x:r.right+9,y:r.top+r.height/2}];case"left-to-right":return[{x:n?.right,y:n?.bottom-n.height/2},{x:(r.left+n.right)/2,y:n?.bottom-n.height/2},{x:(r.left+n.right)/2,y:r.top+r.height/2},{x:r.left-9,y:r.top+r.height/2}];default:return[]}}const b={position:"fixed",top:"0",left:"0",right:"0",bottom:"0",pointerEvents:"none",width:"100%",height:"100%"},E=[];function L(n){const[i,s]=d(E),[c,a]=d(!1),{elements:h}=n,u=e(),f=o((()=>[...new Set([...h.map((e=>e.connectWith?.map((e=>e?.color)))).flat(),"#000000"])].filter(Boolean)),[h]),p=t((()=>{u.current&&window.cancelAnimationFrame(u.current),u.current=window.requestAnimationFrame((()=>{const e=x({elements:h}).map((e=>{const{from:t,to:o}=e||{},n=o?.map((e=>{const o=y({from:t,to:e});if(!o)return;const n=v({paths:o,edge:e?.edge});return/\d/.test(n)?{fromId:t?.id,toId:e?.id,d:n,...e}:void 0}));return n})).filter(Boolean).flat().filter((e=>Boolean(e)));s(e)}))}),[h]),w=t((()=>{a(!0)}),[]),L=t((()=>{a(!1)}),[]),k=t((()=>{c&&p()}),[p,c]);r((()=>{p()}),[p]),r((()=>(window.addEventListener("resize",p,{passive:!0}),window.addEventListener("scroll",p,{passive:!0}),()=>{window.removeEventListener("resize",p),window.removeEventListener("scroll",p)})),[p]);const W=o((()=>new ResizeObserver(p)),[p]);return r((()=>(h.forEach((e=>{const t=g(e);t?.addEventListener("mousedown",w,{passive:!0}),t?.addEventListener("mouseup",L,{passive:!0}),t?.addEventListener("mousemove",k,{passive:!0}),t?.addEventListener("touchstart",w,{passive:!0}),t?.addEventListener("touchend",L,{passive:!0}),t?.addEventListener("touchmove",k,{passive:!0}),t&&W.observe(t)})),()=>{h.forEach((e=>{const t=g(e);t?.removeEventListener("mousedown",w),t?.removeEventListener("mouseup",L),t?.removeEventListener("mousemove",k),t?.removeEventListener("touchstart",w),t?.removeEventListener("touchend",L),t?.removeEventListener("touchmove",k),t&&(W.disconnect(),W.unobserve(t))}))})),[h,p,w,L,k,W]),o((()=>m("svg",{style:b,children:[f?.map((e=>l("defs",{children:l("marker",{id:`triangle-${e}`,markerHeight:"5",markerUnits:"strokeWidth",markerWidth:"5",orient:"auto",refX:"1",refY:"5",viewBox:"0 0 10 10",children:l("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:e})})},e))),i?.map((e=>l("path",{id:`${e?.fromId}-${e?.toId}`,d:e?.d,fill:"none",markerEnd:`url(#triangle-${e?.color})`,stroke:e?.color,strokeWidth:"2",strokeDasharray:"dashed"===e?.stroke?4:0,strokeLinejoin:"round"},e?.d)))]})),[f,i])}function k(){const{elements:e}=h();return l(L,{elements:e})}function W(e){const{children:t}=e;return m(f,{children:[t,l(k,{})]})}export{p as Connect,W as ConnectProvider,L as ConnectLines};
//# sourceMappingURL=index.js.map
