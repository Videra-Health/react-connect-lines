import{useRef as t,useCallback as e,useMemo as o,cloneElement as n,useEffect as r,createContext as i,useContext as s,useReducer as c,useState as l}from"react";import{jsx as d,jsxs as m}from"react/jsx-runtime";const f=i({elements:[],dispatch:()=>null});function a(){if(!s(f))throw new Error("Missing context value");return s(f)}function h(t,e){const{type:o,id:n,element:r,connectWith:i}=e,s=t?.elements?.some((t=>t.id===n)),c={id:n,element:r,connectWith:i||[]};if("add"===o&&r){if(!s)return{...t,elements:[...t.elements,c]};if(s){const e=[...t.elements].map((t=>t.id===n?c:t));return{...t,elements:e}}return t}return"remove"===o?{...t,elements:t.elements.map((t=>({...t,connectWith:t.connectWith?.filter((t=>t.id!==n))}))).filter((t=>t.id!==n))}:t}function u(t){const{children:e}=t,[n,r]=c(h,{elements:[],dispatch:()=>null}),i=o((()=>({elements:n.elements,dispatch:r})),[n]);return d(f.Provider,{value:i,children:e})}function p(i){const{children:s,id:c,connectWith:l}=i,{dispatch:d}=a(),m=t(),f=e((()=>{d({type:"add",id:c,connectWith:l,element:m.current})}),[l,d,c]),h=o((()=>{const{props:t}=s;return n(s,{...t,ref:e=>{m.current=e,"function"==typeof s&&t.ref(e)}})}),[s]);return r((()=>{f()}),[i,f,m]),r((()=>()=>{d({type:"remove",id:c})}),[d,c]),h}const v=t=>{const{paths:e,edge:o}=t;return`M ${e.map(((t,e)=>1===e&&"step"===o?`${t.x} ${t.y}`:1===e&&"bezier"===o?`C ${t.x} ${t.y}`:`${t.x} ${t.y}`)).join(" ")}`};function g(t){return t.element?t.element:document.querySelector(`#${t.id}`)}const w=[];function x(t){const{elements:e}=t;return e.filter((t=>(t?.connectWith||w).length>0)).map((t=>{const{connectWith:o}=t,n=e.filter((t=>o?.map((t=>t.id)).includes(t.id))).map((t=>({rect:g(t)?.getBoundingClientRect(),color:o?.find((e=>e.id===t.id))?.color||"#000000",edge:o?.find((e=>e.id===t.id))?.edge||"bezier",stroke:o?.find((e=>e.id===t.id))?.stroke||"solid",id:t.id})));if(0!==n.length)return{from:{...t,rect:g(t)?.getBoundingClientRect()},to:n}})).filter(Boolean)}function y(t){const{from:e,to:o,root:n}=t,r=e?.rect,i=o?.rect,s=n?.rect;if(!r||!i||!s)return;const c=function(t){const{from:e,to:o}=t,n=e.left-40<o.right&&e.right+o.width>o.right-40,r=e.bottom<o.top&&n,i=e.top>o.bottom&&n,s=e.left>o.right,c=e.right<o.left;return r?"bottom-to-top":i?"top-to-bottom":s?"right-to-left":c?"left-to-right":void 0}({from:r,to:i});switch(c){case"bottom-to-top":return[{x:r?.left+r.width/2-s?.left,y:r?.bottom-s?.top},{x:r?.left+r.width/2-s?.left,y:r.bottom-(r.bottom-i.top)/2-s?.top},{x:i?.left+i.width/2-s?.left,y:r.bottom-(r.bottom-i.top)/2-s?.top},{x:i?.left+i.width/2-s?.left,y:i.top-9-s?.top}];case"top-to-bottom":return[{x:r?.left+r.width/2-s?.left,y:r?.top-s?.top},{x:r?.left+r.width/2-s?.left,y:r.top-(r.top-i.bottom)/2-s?.top},{x:i?.left+i.width/2-s?.left,y:r.top-(r.top-i.bottom)/2-s?.top},{x:i?.left+i.width/2-s?.left,y:i.bottom+9-s?.top}];case"right-to-left":return[{x:r?.left-s?.left,y:r?.bottom-r.height/2-s?.top},{x:(i.right+r.left)/2-s?.left,y:r?.bottom-r.height/2-s?.top},{x:(i.right+r.left)/2-s?.left,y:i.top+i.height/2-s?.top},{x:i.right+9-s?.left,y:i.top+i.height/2-s?.top}];case"left-to-right":return[{x:r?.right-s?.left,y:r?.bottom-r.height/2-s?.top},{x:(i.left+r.right)/2-s?.left,y:r?.bottom-r.height/2-s?.top},{x:(i.left+r.right)/2-s?.left,y:i.top+i.height/2-s?.top},{x:i.left-9-s?.left,y:i.top+i.height/2-s?.top}];default:return[]}}const b={position:"fixed",top:"0",left:"0",right:"0",bottom:"0",pointerEvents:"none",width:"100%",height:"100%"},E=[];function L(n){const[i,s]=l(E),[c,f]=l(!1),{elements:a}=n,h=t(null),u=t(),p=o((()=>[...new Set([...a.map((t=>t.connectWith?.map((t=>t?.color)))).flat(),"#000000"])].filter(Boolean)),[a]),w=e((()=>{u.current&&window.cancelAnimationFrame(u.current),u.current=window.requestAnimationFrame((()=>{const t=x({elements:a}).map((t=>{const{from:e,to:o}=t||{},n=o?.map((t=>{const o=y({from:e,to:t,root:{rect:h.current.getBoundingClientRect()}});if(!o)return;const n=v({paths:o,edge:t?.edge});return/\d/.test(n)?{fromId:e?.id,toId:t?.id,d:n,...t}:void 0}));return n})).filter(Boolean).flat().filter((t=>Boolean(t)));s(t)}))}),[a]),L=e((()=>{f(!0)}),[]),k=e((()=>{f(!1)}),[]),W=e((()=>{c&&w()}),[w,c]);r((()=>{w()}),[w]),r((()=>(window.addEventListener("resize",w,{passive:!0}),window.addEventListener("scroll",w,{passive:!0}),()=>{window.removeEventListener("resize",w),window.removeEventListener("scroll",w)})),[w]);const $=o((()=>new ResizeObserver(w)),[w]);return r((()=>(a.forEach((t=>{const e=g(t);e?.addEventListener("mousedown",L,{passive:!0}),e?.addEventListener("mouseup",k,{passive:!0}),e?.addEventListener("mousemove",W,{passive:!0}),e?.addEventListener("touchstart",L,{passive:!0}),e?.addEventListener("touchend",k,{passive:!0}),e?.addEventListener("touchmove",W,{passive:!0}),e&&$.observe(e)})),()=>{a.forEach((t=>{const e=g(t);e?.removeEventListener("mousedown",L),e?.removeEventListener("mouseup",k),e?.removeEventListener("mousemove",W),e?.removeEventListener("touchstart",L),e?.removeEventListener("touchend",k),e?.removeEventListener("touchmove",W),e&&($.disconnect(),$.unobserve(e))}))})),[a,w,L,k,W,$]),o((()=>m("svg",{style:b,ref:h,children:[p?.map((t=>d("defs",{children:d("marker",{id:`triangle-${t}`,markerHeight:"5",markerUnits:"strokeWidth",markerWidth:"5",orient:"auto",refX:"1",refY:"5",viewBox:"0 0 10 10",children:d("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:t})})},t))),i?.map((t=>d("path",{id:`${t?.fromId}~${t?.toId}`,d:t?.d,fill:"none",markerEnd:`url(#triangle-${t?.color})`,stroke:t?.color,strokeWidth:"2",strokeDasharray:"dashed"===t?.stroke?4:0,strokeLinejoin:"round"},t?.d)))]})),[p,i])}function k(){const{elements:t}=a();return d(L,{elements:t})}function W(t){const{children:e}=t;return m(u,{children:[e,d(k,{})]})}export{p as Connect,W as ConnectProvider,L as ConnectLines};
//# sourceMappingURL=index.js.map
